# .github/workflows/android-ci.yml
name: Android CI

on:
  push:
    branches: [ master ]
    tags:
      - 'v*.*.*'        # ÌÉúÍ∑∏ Ìë∏Ïãú Ïãú Î∞∞Ìè¨ ÌååÏù¥ÌîÑÎùºÏù∏ÎèÑ Îèå Ïàò ÏûàÍ≤å
  pull_request:
    branches: [ master ]
  release:
    types: [ published ] # Release Published Ïù¥Î≤§Ìä∏ÏóêÎèÑ Î∞∞Ìè¨
  workflow_dispatch:

jobs:
  initialize-check:
    name: Initialize Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    outputs:
      should_release: ${{ steps.determine.outputs.should_release }}
      tag: ${{ steps.determine.outputs.tag }}
      title: ${{ steps.determine.outputs.title }}
      body: ${{ steps.determine.outputs.body }}
      docs_only: ${{ steps.determine.outputs.docs_only }}
      testers: ${{ steps.determine.outputs.testers }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Analyze release metadata
        id: determine
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.before || '' }}
        run: |
          set -euo pipefail
          LOG_FILE="${GITHUB_WORKSPACE}/initialize-check.log"
          exec > >(tee "$LOG_FILE")
          exec 2>&1

          SHOULD_RELEASE=false
          TAG=""
          TITLE=""
          DESCRIBE=""
          TESTERS=""

          echo "Checking [release] tag in HEAD commit..."
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "")
          if echo "$COMMIT_MSG" | grep -q "\[release\]"; then
            FOUND=true
          else
            FOUND=false
          fi

          TARGET_BASE="${BASE_SHA}"
          if [ -z "$TARGET_BASE" ]; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              TARGET_BASE=$(git rev-parse HEAD^)
            else
              TARGET_BASE=""
            fi
          fi

          echo "Calculating changed files against base '${TARGET_BASE:-<unknown>}'..."
          if [ -n "$TARGET_BASE" ]; then
            mapfile -t CHANGED_FILES < <(git diff --name-only "$TARGET_BASE" HEAD)
          else
            mapfile -t CHANGED_FILES < <(git ls-tree --name-only -r HEAD)
          fi

          DOCS_ONLY=false
          if [ "${#CHANGED_FILES[@]}" -gt 0 ]; then
            DOCS_ONLY=true
            for file in "${CHANGED_FILES[@]}"; do
              if [[ "$file" =~ (^|/)README[^/]*\.md$ ]]; then
                continue
              fi
              if [[ "$file" =~ ^example_gif/ ]]; then
                continue
              fi
              DOCS_ONLY=false
              break
            done
          fi
          echo "Docs-only commit detected? ${DOCS_ONLY}"

          if [ "$FOUND" = false ]; then
            if [ "$DOCS_ONLY" = true ]; then
              echo "Doc-only commit without [release] block detected. Skipping downstream jobs."
              {
                echo "should_release=false"
                echo "tag="
                echo "title="
                echo "body="
                echo "docs_only=true"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "No [release] block found in HEAD commit. Skipping release."
            {
              echo "should_release=false"
              echo "tag="
              echo "title="
              echo "body="
              echo "docs_only=false"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$DOCS_ONLY" = true ]; then
            echo "Doc-only changes found but release metadata detected. Continuing CI."
            DOCS_ONLY=false
          fi

          echo "Release block detected. Parsing metadata..."
          TAG=$(echo "$COMMIT_MSG" | grep -oP '(?<=Tag)\s*:\s*.*' | head -1 | sed 's/^[[:space:]]*:[[:space:]]*//' | xargs || true)
          TITLE=$(echo "$COMMIT_MSG" | grep -oP '(?<=Title)\s*:\s*.*' | head -1 | sed 's/^[[:space:]]*:[[:space:]]*//' | xargs || true)
          DESCRIBE=$(echo "$COMMIT_MSG" | awk '/Describe\s*:/,0' | tail -n +1 | sed '1s/Describe\s*:\s*//' )
          if [ -z "$DESCRIBE" ]; then
            DESCRIBE=$(echo "$COMMIT_MSG" | awk '/Descrbe\s*:/,0' | tail -n +1 | sed '1s/Descrbe\s*:\s*//' )
          fi
          RAW_TESTERS=$(echo "$COMMIT_MSG" | grep -oP '(?<=Tester)\s*:\s*.*' | head -1 | sed 's/^[[:space:]]*:[[:space:]]*//' || true)
          TESTERS=""
          if [ -n "$RAW_TESTERS" ]; then
            TESTERS=$(echo "$RAW_TESTERS" | sed 's/[[:space:]]//g')
          fi

          if [ -z "$TAG" ]; then
            echo "Error: Tag not found in [release] block."
            exit 1
          fi

          if ! echo "$TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Tag format is invalid. Expected x.x.x."
            exit 1
          fi

          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Error: Tag $TAG already exists."
            exit 1
          fi

          GRADLE_VERSION=$(python3 .github/scripts/read_app_version.py || true)
          if [ -z "$GRADLE_VERSION" ]; then
            echo "Error: Failed to read version from simple_core/build.gradle.kts or simple_xml/build.gradle.kts"
            exit 1
          fi

          if [ "$TAG" != "$GRADLE_VERSION" ]; then
            echo "Error: Version mismatch between commit tag ($TAG) and build.gradle.kts ($GRADLE_VERSION)"
            exit 1
          fi

          echo "Release metadata validated."
          {
            echo "should_release=true"
            echo "tag=$TAG"
            echo "title=$TITLE"
            echo "body<<EOF"
            echo "$DESCRIBE"
            echo "EOF"
            echo "testers=$TESTERS"
            echo "docs_only=false"
          } >> "$GITHUB_OUTPUT"

      - name: Report failure (Initialize Check)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Initialize Check"
          FAILURE_MESSAGE: "Release block validation failed. Please inspect release metadata."
          RELEASE_CHECK_LOG: ${{ github.workspace }}/initialize-check.log
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: |
          FAILURE_LOG_PATH="${GITHUB_WORKSPACE}/initialize-check-failure.log"
          SUMMARY="Initialize Check failed. See logs above for details."
          if [ -f "$RELEASE_CHECK_LOG" ]; then
            python3 .github/scripts/extract_gradle_failure.py "$RELEASE_CHECK_LOG" "$FAILURE_LOG_PATH"
            SUMMARY="$(head -n 1 "$FAILURE_LOG_PATH" | tr -d '\r')"
          else
            echo "$SUMMARY" > "$FAILURE_LOG_PATH"
          fi
          export FAILURE_LOG_PATH
          export FAILURE_MESSAGE="$SUMMARY"
          bash .github/scripts/report_action_error.sh

  unit-test:
    name: Unit Tests
    if: ${{ needs.initialize-check.outputs.docs_only != 'true' }}
    runs-on: ubuntu-latest
    needs: initialize-check
    permissions:
      contents: read
      checks: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run pure unit tests only
        run: bash -o pipefail -c "./gradlew :simple_core:testUnit :simple_xml:testUnit |& tee unit-test.log"

      - name: Capture failure snippet (Unit Tests)
        if: failure()
        id: unit_test_failure_snippet
        run: |
          python3 .github/scripts/extract_gradle_failure.py unit-test.log unit-test-failure-snippet.log
          SUMMARY="$(head -n 1 unit-test-failure-snippet.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Unit Tests job failed. Please inspect Gradle tasks :simple_core:testUnit and :simple_xml:testUnit."
          fi
          {
            echo "UNIT_TEST_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "UNIT_TEST_FAILURE_LOG_PATH=$(pwd)/unit-test-failure-snippet.log"
          } >> "$GITHUB_ENV"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            simple_core/build/test-results/testUnit/**/*.xml
            simple_xml/build/test-results/testUnit/**/*.xml
          check_name: Unit Test Results

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-report
          path: |
            simple_core/build/reports/tests/testUnit/
            simple_xml/build/reports/tests/testUnit/
          retention-days: 30

      - name: Report failure (Unit Tests)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Unit Tests"
          FAILURE_MESSAGE: ${{ env.UNIT_TEST_FAILURE_SUMMARY || 'Unit Tests job failed. Please inspect Gradle task :simple_ui:testUnit.' }}
          FAILURE_LOG_PATH: ${{ env.UNIT_TEST_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  robolectric-test:
    name: Robolectric Tests
    if: ${{ needs.initialize-check.outputs.docs_only != 'true' }}
    runs-on: ubuntu-latest
    needs: unit-test  # unit-testÍ∞Ä ÏÑ±Í≥µÌï¥Ïïº Ïã§Ìñâ
    permissions:
      contents: read
      checks: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Robolectric tests
        run: bash -o pipefail -c "./gradlew :simple_core:testRobolectric :simple_xml:testRobolectric |& tee robolectric-test.log"

      - name: Capture failure snippet (Robolectric Tests)
        if: failure()
        id: robolectric_failure_snippet
        run: |
          python3 .github/scripts/extract_gradle_failure.py robolectric-test.log robolectric-failure-snippet.log
          SUMMARY="$(head -n 1 robolectric-failure-snippet.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Robolectric Tests job failed. Check Gradle task :simple_ui:testRobolectric."
          fi
          {
            echo "ROBO_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "ROBO_FAILURE_LOG_PATH=$(pwd)/robolectric-failure-snippet.log"
          } >> "$GITHUB_ENV"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            simple_core/build/test-results/testRobolectric/**/*.xml
            simple_xml/build/test-results/testRobolectric/**/*.xml
          check_name: Robolectric Test Results

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robolectric-test-report
          path: |
            simple_core/build/reports/tests/testRobolectric/
            simple_xml/build/reports/tests/testRobolectric/
          retention-days: 30

      - name: Report failure (Robolectric Tests)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Robolectric Tests"
          FAILURE_MESSAGE: ${{ env.ROBO_FAILURE_SUMMARY || 'Robolectric Tests job failed. Check Gradle task :simple_ui:testRobolectric.' }}
          FAILURE_LOG_PATH: ${{ env.ROBO_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  build:
    name: Build and Lint Check
    if: ${{ needs.initialize-check.outputs.docs_only != 'true' }}
    runs-on: ubuntu-latest
    needs: robolectric-test  # robolectric-testÍ∞Ä ÏÑ±Í≥µÌï¥Ïïº Ïã§Ìñâ
    permissions:
      contents: read
      checks: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Google Services config
        run: |
          cat <<'EOF' > app/google-services.json
          ${{ secrets.FIREBASE_CREDENTIALS }}
          EOF

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Set up Android SDK (base)
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install SDK packages
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run all tests for coverage
        run: bash -o pipefail -c "./gradlew :simple_core:testAll :simple_xml:testAll |& tee build-testAll.log"

      - name: Capture failure snippet (testAll)
        if: failure()
        run: |
          python3 .github/scripts/extract_gradle_failure.py build-testAll.log build-testAll-failure.log
          SUMMARY="$(head -n 1 build-testAll-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Build job failed while running :simple_core:testAll and :simple_xml:testAll."
          fi
          {
            echo "BUILD_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "BUILD_FAILURE_LOG_PATH=$(pwd)/build-testAll-failure.log"
            echo "BUILD_FAILURE_SOURCE=:simple_core:testAll and :simple_xml:testAll"
          } >> "$GITHUB_ENV"

      - name: Generate Kover coverage report
        run: bash -o pipefail -c "./gradlew :simple_core:koverHtmlReport :simple_xml:koverHtmlReport |& tee build-kover.log"
        if: always()

      - name: Capture failure snippet (kover)
        if: failure()
        run: |
          python3 .github/scripts/extract_gradle_failure.py build-kover.log build-kover-failure.log
          SUMMARY="$(head -n 1 build-kover-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Build job failed while running koverHtmlReport."
          fi
          {
            echo "BUILD_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "BUILD_FAILURE_LOG_PATH=$(pwd)/build-kover-failure.log"
            echo "BUILD_FAILURE_SOURCE=koverHtmlReport"
          } >> "$GITHUB_ENV"

      - name: Assemble
        run: bash -o pipefail -c "./gradlew assemble --stacktrace |& tee build-assemble.log"

      - name: Capture failure snippet (assemble)
        if: failure()
        run: |
          python3 .github/scripts/extract_gradle_failure.py build-assemble.log build-assemble-failure.log
          SUMMARY="$(head -n 1 build-assemble-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Build job failed while assembling artifacts."
          fi
          {
            echo "BUILD_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "BUILD_FAILURE_LOG_PATH=$(pwd)/build-assemble-failure.log"
            echo "BUILD_FAILURE_SOURCE=assemble"
          } >> "$GITHUB_ENV"

      - name: Android Lint (non-blocking)
        run: bash -o pipefail -c "./gradlew lint |& tee build-lint.log"
        # continue-on-error: true

      - name: Capture failure snippet (lint)
        if: failure()
        run: |
          python3 .github/scripts/extract_gradle_failure.py build-lint.log build-lint-failure.log
          SUMMARY="$(head -n 1 build-lint-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Build job failed while running lint."
          fi
          {
            echo "BUILD_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "BUILD_FAILURE_LOG_PATH=$(pwd)/build-lint-failure.log"
            echo "BUILD_FAILURE_SOURCE=lint"
          } >> "$GITHUB_ENV"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            simple_core/build/reports/kover/html/
            simple_xml/build/reports/kover/html/
          retention-days: 30

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            **/build/reports/**
            **/build/test-results/**
          if-no-files-found: ignore

      - name: Report failure (Build and Lint Check)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Build and Lint Check"
          FAILURE_MESSAGE: ${{ env.BUILD_FAILURE_SUMMARY || 'Build and Lint Check job failed (tests, coverage, assemble, or lint).' }}
          FAILURE_LOG_PATH: ${{ env.BUILD_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  release:
    name: Release from Commit Message
    runs-on: ubuntu-latest
    needs: [build, initialize-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.initialize-check.outputs.should_release == 'true'
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Create Git Tag
        run: |
          TAG="${{ needs.initialize-check.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash -o pipefail -c "git tag -a \"$TAG\" -m \"Release $TAG\" | tee -a release-tag.log"
          bash -o pipefail -c "git push origin \"$TAG\" | tee -a release-tag.log"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.initialize-check.outputs.tag }}
          release_name: ${{ needs.initialize-check.outputs.title }}
          body: ${{ needs.initialize-check.outputs.body }}
          draft: false
          prerelease: false

      - name: Capture failure snippet (Release)
        if: failure()
        run: |
          LOG_FILE="release-tag.log"
          SUMMARY="Release job failed. Verify tagging or GitHub release steps."
          if [ -f "$LOG_FILE" ]; then
            python3 .github/scripts/extract_gradle_failure.py "$LOG_FILE" release-failure.log
            SUMMARY="$(head -n 1 release-failure.log | tr -d '\r')"
            {
              echo "RELEASE_FAILURE_SUMMARY<<EOF"
              echo "$SUMMARY"
              echo "EOF"
              echo "RELEASE_FAILURE_LOG_PATH=$(pwd)/release-failure.log"
            } >> "$GITHUB_ENV"
          else
            {
              echo "RELEASE_FAILURE_SUMMARY<<EOF"
              echo "$SUMMARY"
              echo "EOF"
            } >> "$GITHUB_ENV"

      - name: Report failure (Release from Commit Message)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Release from Commit Message"
          FAILURE_MESSAGE: ${{ env.RELEASE_FAILURE_SUMMARY || 'Release job failed. Verify tagging or GitHub release steps.' }}
          FAILURE_LOG_PATH: ${{ env.RELEASE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  assemble-apk:
    name: Assemble APK
    runs-on: ubuntu-latest
    needs: [release, initialize-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.initialize-check.outputs.should_release == 'true'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Google Services config
        run: |
          cat <<'EOF' > app/google-services.json
          ${{ secrets.FIREBASE_CREDENTIALS }}
          EOF

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install SDK packages
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # - name: Assemble release APK
      #   id: assemble_release
      #   run: bash -o pipefail -c "./gradlew :app:assembleRelease --stacktrace |& tee assemble-release.log"

      - name: Assemble verification APK
        id: assemble_verification
        run: bash -o pipefail -c "./gradlew :app:assembleVerification --stacktrace |& tee assemble-verification.log"

      # - name: Capture failure snippet (Assemble release APK)
      #   if: failure()
      #   run: |
      #     python3 .github/scripts/extract_gradle_failure.py assemble-release.log assemble-apk-failure.log
      #     SUMMARY="$(head -n 1 assemble-apk-failure.log | tr -d '\r')"
      #     if [ -z "$SUMMARY" ]; then
      #       SUMMARY="Failed while assembling release APK."
      #     fi
      #     {
      #       echo "ASSEMBLE_FAILURE_SUMMARY<<EOF"
      #       echo "$SUMMARY"
      #       echo "EOF"
      #       echo "ASSEMBLE_FAILURE_LOG_PATH=$(pwd)/assemble-apk-failure.log"
      #     } >> "$GITHUB_ENV"

      - name: Capture failure snippet (Assemble verification APK)
        if: failure()
        run: |
          python3 .github/scripts/extract_gradle_failure.py assemble-verification.log assemble-apk-failure.log
          SUMMARY="$(head -n 1 assemble-apk-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Failed while assembling verification APK."
          fi
          {
            echo "ASSEMBLE_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "ASSEMBLE_FAILURE_LOG_PATH=$(pwd)/assemble-apk-failure.log"
          } >> "$GITHUB_ENV"

      # - name: Determine release artifact path
      #   id: release_artifact
      #   run: |
      #     set -euo pipefail
      #     RELEASE_APK="app/build/outputs/apk/release/app-release.apk"
      #     RELEASE_UNSIGNED="app/build/outputs/apk/release/app-release-unsigned.apk"
      #     SELECTED=""
      #     SOURCE=""
      #     if [ -f "$RELEASE_APK" ]; then
      #       SELECTED="$RELEASE_APK"
      #       SOURCE="signed release"
      #     elif [ -f "$RELEASE_UNSIGNED" ]; then
      #       SELECTED="$RELEASE_UNSIGNED"
      #       SOURCE="unsigned release"
      #     fi
      #     if [ -n "$SELECTED" ]; then
      #       echo "artifact=$SELECTED" >> "$GITHUB_OUTPUT"
      #       echo "artifact_source=$SOURCE" >> "$GITHUB_OUTPUT"
      #       echo "Selected $SOURCE artifact: $SELECTED"
      #     else
      #       echo "artifact=" >> "$GITHUB_OUTPUT"
      #       echo "artifact_source=" >> "$GITHUB_OUTPUT"
      #       echo "::error::No release APK artifacts found."
      #       exit 1
      #     fi

      - name: Determine verification artifact path
        id: verification_artifact
        run: |
          set -euo pipefail
          VERIFICATION_APK="app/build/outputs/apk/verification/app-verification.apk"
          VERIFICATION_UNSIGNED="app/build/outputs/apk/verification/app-verification-unsigned.apk"
          SELECTED=""
          SOURCE=""
          if [ -f "$VERIFICATION_APK" ]; then
            SELECTED="$VERIFICATION_APK"
            SOURCE="signed verification"
          elif [ -f "$VERIFICATION_UNSIGNED" ]; then
            SELECTED="$VERIFICATION_UNSIGNED"
            SOURCE="unsigned verification"
          fi
          if [ -n "$SELECTED" ]; then
            echo "artifact=$SELECTED" >> "$GITHUB_OUTPUT"
            echo "artifact_source=$SOURCE" >> "$GITHUB_OUTPUT"
            echo "Selected $SOURCE artifact: $SELECTED"
          else
            echo "artifact=" >> "$GITHUB_OUTPUT"
            echo "artifact_source=" >> "$GITHUB_OUTPUT"
            echo "::error::No verification APK artifacts found."
            exit 1
          fi

      # - name: Upload release APK artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: release-apk
      #     path: ${{ steps.release_artifact.outputs.artifact }}
      #     retention-days: 7

      - name: Upload verification APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: verification-apk
          path: ${{ steps.verification_artifact.outputs.artifact }}
          retention-days: 7

      - name: Report failure (Assemble APK)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Assemble APK"
          FAILURE_MESSAGE: ${{ env.ASSEMBLE_FAILURE_SUMMARY || 'Assemble APK job failed.' }}
          FAILURE_LOG_PATH: ${{ env.ASSEMBLE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  firebase-distribution:
    name: Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [assemble-apk, initialize-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.initialize-check.outputs.should_release == 'true'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Firebase credentials
        run: |
          cat <<'EOF' > "$RUNNER_TEMP/firebase-app-dist.json"
          ${{ secrets.FIREBASE_APP_DIST }}
          EOF
          echo "FIREBASE_CREDENTIALS_FILE=$RUNNER_TEMP/firebase-app-dist.json" >> $GITHUB_ENV

      - name: Prepare Google Services config
        run: |
          cat <<'EOF' > app/google-services.json
          ${{ secrets.FIREBASE_CREDENTIALS }}
          EOF

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install SDK packages
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # - name: Download release APK artifact
      #   id: download_release
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: release-apk
      #     path: ./downloaded-apk

      - name: Download verification APK artifact
        id: download_verification
        uses: actions/download-artifact@v4
        with:
          name: verification-apk
          path: ./downloaded-apk

      - name: Determine downloaded artifact path
        id: artifact_path
        run: |
          set -euo pipefail
          APK_FILE=$(find ./downloaded-apk -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            ABS_PATH="$(realpath "$APK_FILE")"
            echo "artifact=$ABS_PATH" >> "$GITHUB_OUTPUT"
            echo "Found APK: $ABS_PATH"
          else
            echo "artifact=" >> "$GITHUB_OUTPUT"
            echo "::error::No APK found in downloaded artifact."
            exit 1
          fi

      # - name: Distribute release to Firebase
      #   id: upload_release
      #   continue-on-error: true
      #   env:
      #     FIREBASE_RELEASE_NOTES: ${{ needs.initialize-check.outputs.body }}
      #     FIREBASE_ARTIFACT_OVERRIDE: ${{ steps.artifact_path.outputs.artifact }}
      #     FIREBASE_TESTERS: ${{ needs.initialize-check.outputs.testers }}
      #   run: |
      #     set -euo pipefail
      #     LOG_FILE="firebase-appdist-release.log"
      #     ARTIFACT="${FIREBASE_ARTIFACT_OVERRIDE}"
      #     if [ -z "$ARTIFACT" ]; then
      #       echo "Release artifact path not found." | tee "$LOG_FILE"
      #       exit 1
      #     fi
      #     ./gradlew :app:appDistributionUploadRelease -PfirebaseArtifactPath="$ARTIFACT" --stacktrace |& tee "$LOG_FILE"

      - name: Distribute verification to Firebase
        id: upload_verification
        env:
          FIREBASE_RELEASE_NOTES: ${{ needs.initialize-check.outputs.body }}
          FIREBASE_ARTIFACT_OVERRIDE: ${{ steps.artifact_path.outputs.artifact }}
          FIREBASE_TESTERS: ${{ needs.initialize-check.outputs.testers }}
        run: |
          set -euo pipefail
          LOG_FILE="firebase-appdist-verification.log"
          ARTIFACT="${FIREBASE_ARTIFACT_OVERRIDE}"
          if [ -z "$ARTIFACT" ]; then
            echo "Verification artifact path not found." | tee "$LOG_FILE"
            exit 1
          fi
          ./gradlew :app:appDistributionUploadVerification -PfirebaseArtifactPath="$ARTIFACT" --stacktrace |& tee "$LOG_FILE"

      # - name: Handle release upload failure and prepare fallback
      #   if: steps.upload_release.outcome == 'failure'
      #   run: |
      #     python3 .github/scripts/extract_gradle_failure.py firebase-appdist-release.log firebase-appdist-release-failure.log || true
      #     SUMMARY="$(head -n 1 firebase-appdist-release-failure.log | tr -d '\r')"
      #     if [ -z "$SUMMARY" ]; then
      #       SUMMARY="Firebase release distribution failed. Falling back to debug variant."
      #       cp firebase-appdist-release.log firebase-appdist-release-failure.log
      #     fi
      #     {
      #       echo "RELEASE_APPDIST_FAILURE_SUMMARY<<EOF"
      #       echo "$SUMMARY"
      #       echo "EOF"
      #       echo "RELEASE_APPDIST_FAILURE_LOG_PATH=$(pwd)/firebase-appdist-release-failure.log"
      #     } >> "$GITHUB_ENV"
      #     {
      #       echo "### Firebase release upload failed" >> "$GITHUB_STEP_SUMMARY"
      #       echo "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"
      #       echo "" >> "$GITHUB_STEP_SUMMARY"
      #       echo "Attempting debug variant upload..." >> "$GITHUB_STEP_SUMMARY"
      #     }

      # - name: Assemble debug APK (fallback)
      #   id: assemble_debug
      #   if: steps.upload_release.outcome == 'failure'
      #   run: bash -o pipefail -c "./gradlew :app:assembleDebug --stacktrace |& tee assemble-debug.log"

      # - name: Capture failure snippet (Assemble debug APK)
      #   if: failure() && steps.assemble_debug.outcome == 'failure'
      #   run: |
      #     python3 .github/scripts/extract_gradle_failure.py assemble-debug.log firebase-appdist-failure.log
      #     SUMMARY="$(head -n 1 firebase-appdist-failure.log | tr -d '\r')"
      #     if [ -z "$SUMMARY" ]; then
      #       SUMMARY="Failed while assembling debug APK during Firebase fallback."
      #     fi
      #     {
      #       echo "FIREBASE_FAILURE_SUMMARY<<EOF"
      #       echo "$SUMMARY"
      #       echo "EOF"
      #       echo "FIREBASE_FAILURE_LOG_PATH=$(pwd)/firebase-appdist-failure.log"
      #     } >> "$GITHUB_ENV"

      # - name: Determine debug artifact path
      #   id: debug_artifact
      #   if: steps.upload_release.outcome == 'failure'
      #   run: |
      #     set -euo pipefail
      #     DEBUG_APK="app/build/outputs/apk/debug/app-debug.apk"
      #     if [ -f "$DEBUG_APK" ]; then
      #       ABS_PATH="$(realpath "$DEBUG_APK")"
      #       echo "artifact=$ABS_PATH" >> "$GITHUB_OUTPUT"
      #       echo "artifact_source=debug" >> "$GITHUB_OUTPUT"
      #       echo "Selected debug artifact: $ABS_PATH"
      #     else
      #       echo "artifact=" >> "$GITHUB_OUTPUT"
      #       echo "artifact_source=" >> "$GITHUB_OUTPUT"
      #       echo "::warning::Debug APK not found after assembleDebug."
      #     fi

      # - name: Distribute debug to Firebase
      #   id: upload_debug
      #   if: steps.upload_release.outcome == 'failure'
      #   env:
      #     FIREBASE_RELEASE_NOTES: ${{ needs.initialize-check.outputs.body }}
      #     FIREBASE_ARTIFACT_OVERRIDE: ${{ steps.debug_artifact.outputs.artifact }}
      #     FIREBASE_TESTERS: ${{ needs.initialize-check.outputs.testers }}
      #   run: |
      #     set -euo pipefail
      #     LOG_FILE="firebase-appdist-debug.log"
      #     ARTIFACT="${FIREBASE_ARTIFACT_OVERRIDE}"
      #     if [ -z "$ARTIFACT" ]; then
      #       echo "Debug artifact path not found. Ensure fallback assemble produced app-debug.apk." | tee "$LOG_FILE"
      #       exit 1
      #     fi
      #     ./gradlew :app:appDistributionUploadDebug -PfirebaseArtifactPath="$ARTIFACT" --stacktrace |& tee "$LOG_FILE"

      - name: Capture failure snippet (Firebase App Distribution)
        if: failure()
        run: |
          LOG_FILE="firebase-appdist-verification.log"
          python3 .github/scripts/extract_gradle_failure.py "$LOG_FILE" firebase-appdist-failure.log
          SUMMARY="$(head -n 1 firebase-appdist-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Firebase distribution failed while uploading verification APK."
          fi
          {
            echo "FIREBASE_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "FIREBASE_FAILURE_LOG_PATH=$(pwd)/firebase-appdist-failure.log"
          } >> "$GITHUB_ENV"

      - name: Report failure (Firebase App Distribution)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Firebase App Distribution"
          FAILURE_MESSAGE: ${{ env.FIREBASE_FAILURE_SUMMARY || 'Firebase distribution failed while uploading APK.' }}
          FAILURE_LOG_PATH: ${{ env.FIREBASE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  finalize-check:
    name: Finalize Check
    runs-on: ubuntu-latest
    needs: [firebase-distribution, initialize-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.initialize-check.outputs.should_release == 'true'
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate Dokka documentation
        run: bash -o pipefail -c "./gradlew dokkaHtmlMultiModuleCustom --no-daemon |& tee finalize-dokka.log"

      - name: Verify documentation generated
        run: |
          if [ ! -f "docs/api/index.html" ]; then
            echo "‚ùå Documentation not generated!"
            exit 1
          fi
          echo "‚úÖ Documentation generated successfully"
          ls -la docs/api/

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit documentation
        run: |
          git add docs/api/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìö Update Dokka documentation for v${{ needs.initialize-check.outputs.tag }}

            ü§ñ Generated with [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
          fi

      - name: Capture failure snippet (Finalize Check)
        if: failure()
        run: |
          LOG_FILE="finalize-dokka.log"
          python3 .github/scripts/extract_gradle_failure.py "$LOG_FILE" finalize-check-failure.log || true
          SUMMARY="$(head -n 1 finalize-check-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Finalize Check failed while generating documentation."
          fi
          {
            echo "FINALIZE_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "FINALIZE_FAILURE_LOG_PATH=$(pwd)/finalize-check-failure.log"
          } >> "$GITHUB_ENV"

      - name: Report failure (Finalize Check)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Finalize Check"
          FAILURE_MESSAGE: ${{ env.FINALIZE_FAILURE_SUMMARY || 'Finalize Check failed while generating documentation.' }}
          FAILURE_LOG_PATH: ${{ env.FINALIZE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh
