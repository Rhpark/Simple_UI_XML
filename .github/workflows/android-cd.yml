# .github/workflows/android-cd.yml
name: 2. Android CD

on:
  workflow_run:
    workflows: ["1. Android CI"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:

jobs:
  check-ci-success:
    name: Check CI Success
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      should_release: ${{ steps.load_metadata.outputs.should_release }}
      tag: ${{ steps.load_metadata.outputs.tag }}
      title: ${{ steps.load_metadata.outputs.title }}
      body: ${{ steps.load_metadata.outputs.body }}
      testers: ${{ steps.load_metadata.outputs.testers }}
    steps:
      - name: Download metadata artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: android-ci.yml
          name: release-metadata
          path: metadata
          if_no_artifact_found: ignore

      - name: Load metadata
        id: load_metadata
        run: |
          if [ -f "metadata/release-metadata.json" ]; then
            cat metadata/release-metadata.json
            echo "should_release=$(jq -r .should_release metadata/release-metadata.json)" >> $GITHUB_OUTPUT
            echo "tag=$(jq -r .tag metadata/release-metadata.json)" >> $GITHUB_OUTPUT
            echo "title=$(jq -r .title metadata/release-metadata.json)" >> $GITHUB_OUTPUT
            BODY=$(jq -r .body metadata/release-metadata.json)
            {
              echo "body<<EOF"
              echo "$BODY"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "testers=$(jq -r .testers metadata/release-metadata.json)" >> $GITHUB_OUTPUT
          else
            echo "No metadata found. Skipping release."
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "tag=" >> $GITHUB_OUTPUT
            echo "title=" >> $GITHUB_OUTPUT
            echo "body=" >> $GITHUB_OUTPUT
            echo "testers=" >> $GITHUB_OUTPUT
          fi

  release:
    name: Release from Commit Message
    runs-on: ubuntu-latest
    needs: check-ci-success
    if: needs.check-ci-success.outputs.should_release == 'true'
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Create Git Tag
        run: |
          TAG="${{ needs.check-ci-success.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          bash -o pipefail -c "git tag -a \"$TAG\" -m \"Release $TAG\" | tee -a release-tag.log"
          bash -o pipefail -c "git push origin \"$TAG\" | tee -a release-tag.log"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.check-ci-success.outputs.tag }}
          release_name: ${{ needs.check-ci-success.outputs.title }}
          body: ${{ needs.check-ci-success.outputs.body }}
          draft: false
          prerelease: false

      - name: Capture failure snippet (Release)
        if: failure()
        run: |
          LOG_FILE="release-tag.log"
          SUMMARY="Release job failed. Verify tagging or GitHub release steps."
          if [ -f "$LOG_FILE" ]; then
            python3 .github/scripts/extract_gradle_failure.py "$LOG_FILE" release-failure.log
            SUMMARY="$(head -n 1 release-failure.log | tr -d '\r')"
            {
              echo "RELEASE_FAILURE_SUMMARY<<EOF"
              echo "$SUMMARY"
              echo "EOF"
              echo "RELEASE_FAILURE_LOG_PATH=$(pwd)/release-failure.log"
            } >> "$GITHUB_ENV"
          else
            {
              echo "RELEASE_FAILURE_SUMMARY<<EOF"
              echo "$SUMMARY"
              echo "EOF"
            } >> "$GITHUB_ENV"

      - name: Report failure (Release from Commit Message)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Release from Commit Message"
          FAILURE_MESSAGE: ${{ env.RELEASE_FAILURE_SUMMARY || 'Release job failed. Verify tagging or GitHub release steps.' }}
          FAILURE_LOG_PATH: ${{ env.RELEASE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  assemble-apk:
    name: Assemble APK
    runs-on: ubuntu-latest
    needs: [release, check-ci-success]
    if: needs.check-ci-success.outputs.should_release == 'true'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Google Services config
        run: |
          cat <<'EOF' > app/google-services.json
          ${{ secrets.FIREBASE_CREDENTIALS }}
          EOF

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install SDK packages
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Assemble verification APK
        id: assemble_verification
        run: bash -o pipefail -c "./gradlew :app:assembleVerification --stacktrace |& tee assemble-verification.log"

      - name: Capture failure snippet (Assemble verification APK)
        if: failure()
        run: |
          python3 .github/scripts/extract_gradle_failure.py assemble-verification.log assemble-apk-failure.log
          SUMMARY="$(head -n 1 assemble-apk-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Failed while assembling verification APK."
          fi
          {
            echo "ASSEMBLE_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "ASSEMBLE_FAILURE_LOG_PATH=$(pwd)/assemble-apk-failure.log"
          } >> "$GITHUB_ENV"

      - name: Determine verification artifact path
        id: verification_artifact
        run: |
          set -euo pipefail
          VERIFICATION_APK="app/build/outputs/apk/verification/app-verification.apk"
          VERIFICATION_UNSIGNED="app/build/outputs/apk/verification/app-verification-unsigned.apk"
          SELECTED=""
          SOURCE=""
          if [ -f "$VERIFICATION_APK" ]; then
            SELECTED="$VERIFICATION_APK"
            SOURCE="signed verification"
          elif [ -f "$VERIFICATION_UNSIGNED" ]; then
            SELECTED="$VERIFICATION_UNSIGNED"
            SOURCE="unsigned verification"
          fi
          if [ -n "$SELECTED" ]; then
            echo "artifact=$SELECTED" >> "$GITHUB_OUTPUT"
            echo "artifact_source=$SOURCE" >> "$GITHUB_OUTPUT"
            echo "Selected $SOURCE artifact: $SELECTED"
          else
            echo "artifact=" >> "$GITHUB_OUTPUT"
            echo "artifact_source=" >> "$GITHUB_OUTPUT"
            echo "::error::No verification APK artifacts found."
            exit 1
          fi

      - name: Upload verification APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: verification-apk
          path: ${{ steps.verification_artifact.outputs.artifact }}
          retention-days: 7

      - name: Report failure (Assemble APK)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Assemble APK"
          FAILURE_MESSAGE: ${{ env.ASSEMBLE_FAILURE_SUMMARY || 'Assemble APK job failed.' }}
          FAILURE_LOG_PATH: ${{ env.ASSEMBLE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh

  firebase-distribution:
    name: Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [assemble-apk, check-ci-success]
    if: needs.check-ci-success.outputs.should_release == 'true'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Firebase credentials
        run: |
          cat <<'EOF' > "$RUNNER_TEMP/firebase-app-dist.json"
          ${{ secrets.FIREBASE_APP_DIST }}
          EOF
          echo "FIREBASE_CREDENTIALS_FILE=$RUNNER_TEMP/firebase-app-dist.json" >> $GITHUB_ENV

      - name: Prepare Google Services config
        run: |
          cat <<'EOF' > app/google-services.json
          ${{ secrets.FIREBASE_CREDENTIALS }}
          EOF

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install SDK packages
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Download verification APK artifact
        id: download_verification
        uses: actions/download-artifact@v4
        with:
          name: verification-apk
          path: ./downloaded-apk

      - name: Determine downloaded artifact path
        id: artifact_path
        run: |
          set -euo pipefail
          APK_FILE=$(find ./downloaded-apk -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            ABS_PATH="$(realpath "$APK_FILE")"
            echo "artifact=$ABS_PATH" >> "$GITHUB_OUTPUT"
            echo "Found APK: $ABS_PATH"
          else
            echo "artifact=" >> "$GITHUB_OUTPUT"
            echo "::error::No APK found in downloaded artifact."
            exit 1
          fi

      - name: Distribute verification to Firebase
        id: upload_verification
        env:
          FIREBASE_RELEASE_NOTES: ${{ needs.check-ci-success.outputs.body }}
          FIREBASE_ARTIFACT_OVERRIDE: ${{ steps.artifact_path.outputs.artifact }}
          FIREBASE_TESTERS: ${{ needs.check-ci-success.outputs.testers }}
        run: |
          set -euo pipefail
          LOG_FILE="firebase-appdist-verification.log"
          ARTIFACT="${FIREBASE_ARTIFACT_OVERRIDE}"
          if [ -z "$ARTIFACT" ]; then
            echo "Verification artifact path not found." | tee "$LOG_FILE"
            exit 1
          fi
          ./gradlew :app:appDistributionUploadVerification -PfirebaseArtifactPath="$ARTIFACT" --stacktrace |& tee "$LOG_FILE"

      - name: Capture failure snippet (Firebase App Distribution)
        if: failure()
        run: |
          LOG_FILE="firebase-appdist-verification.log"
          python3 .github/scripts/extract_gradle_failure.py "$LOG_FILE" firebase-appdist-failure.log
          SUMMARY="$(head -n 1 firebase-appdist-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Firebase distribution failed while uploading verification APK."
          fi
          {
            echo "FIREBASE_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "FIREBASE_FAILURE_LOG_PATH=$(pwd)/firebase-appdist-failure.log"
          } >> "$GITHUB_ENV"

      - name: Report failure (Firebase App Distribution)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Firebase App Distribution"
          FAILURE_MESSAGE: ${{ env.FIREBASE_FAILURE_SUMMARY || 'Firebase distribution failed while uploading APK.' }}
          FAILURE_LOG_PATH: ${{ env.FIREBASE_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        run: bash .github/scripts/report_action_error.sh
